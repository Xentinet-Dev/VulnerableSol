/**
 * Exploit Interfaces for Claude's Harness Integration
 * 
 * This file exports all types and interfaces needed for Claude's
 * ExploitSimulationHarness to integrate with our codebase.
 */

import { Vulnerability, Severity, VulnerabilityCategory } from "./vulnerability.js";
import { ExploitAttempt, ExploitabilityStatus } from "../simulator/exploit-simulator.js";

/**
 * Re-export Vulnerability interface for Claude's harness
 */
export type { Vulnerability };

/**
 * Re-export ExploitAttempt interface
 */
export type { ExploitAttempt };

/**
 * Re-export ExploitabilityStatus enum
 */
export { ExploitabilityStatus };

/**
 * Sample IDL structure (Anchor format)
 * This is a template showing the structure Claude's harness should expect
 */
export const SAMPLE_IDL = {
  version: "0.1.0",
  name: "example_program",
  instructions: [
    {
      name: "initialize",
      discriminator: [175, 175, 109, 31, 13, 152, 155, 237], // 8-byte discriminator
      accounts: [
        {
          name: "authority",
          isMut: true,
          isSigner: true,
        },
        {
          name: "state",
          isMut: true,
          isSigner: false,
        },
        {
          name: "systemProgram",
          isMut: false,
          isSigner: false,
        },
      ],
      args: [
        {
          name: "initialValue",
          type: "u64",
        },
      ],
    },
    {
      name: "transfer",
      discriminator: [219, 200, 103, 4, 70, 168, 211, 56],
      accounts: [
        {
          name: "from",
          isMut: true,
          isSigner: true,
        },
        {
          name: "to",
          isMut: true,
          isSigner: false,
        },
        {
          name: "tokenProgram",
          isMut: false,
          isSigner: false,
        },
      ],
      args: [
        {
          name: "amount",
          type: "u64",
        },
      ],
    },
  ],
  accounts: [
    {
      name: "State",
      type: {
        kind: "struct",
        fields: [
          {
            name: "value",
            type: "u64",
          },
        ],
      },
    },
  ],
  types: [],
  metadata: {
    address: "11111111111111111111111111111111",
  },
};

/**
 * Supported vulnerability types
 * These match the strategy names in ExploitStrategies
 */
export const VULNERABILITY_TYPES = [
  "type-confusion",
  "type_confusion",
  "missing-signer",
  "missing_signer",
  "overflow",
  "unchecked_arithmetic",
  "missing-ownership",
  "unchecked_owner",
  "pda-spoofing",
  "pda_spoofing",
  "reentrancy",
  "arbitrary-write",
  "arbitrary_write",
  "authority-misuse",
  "authority_misuse",
  "owner-spoofing",
  "owner_spoofing",
  "deserialization-panic",
  "deserialization_panic",
  "init-without-rent",
  "init_without_rent",
] as const;

/**
 * Vulnerability type union
 */
export type VulnerabilityType = typeof VULNERABILITY_TYPES[number];

/**
 * IDL structure interface
 */
export interface Idl {
  version: string;
  name: string;
  instructions: IdlInstruction[];
  accounts?: IdlAccountDef[];
  types?: IdlTypeDef[];
  metadata?: {
    address?: string;
    [key: string]: any;
  };
}

/**
 * IDL Instruction structure
 */
export interface IdlInstruction {
  name: string;
  discriminator?: number[] | string;
  accounts: IdlAccount[];
  args?: IdlField[];
}

/**
 * IDL Account structure
 */
export interface IdlAccount {
  name: string;
  isMut?: boolean;
  isSigner?: boolean;
  isWritable?: boolean;
  pubkey?: string;
}

/**
 * IDL Account Definition (for account types)
 */
export interface IdlAccountDef {
  name: string;
  type: IdlTypeDef;
}

/**
 * IDL Type Definition
 */
export interface IdlTypeDef {
  kind: "struct" | "enum" | "type";
  fields?: IdlField[];
  variants?: any[];
  type?: string;
}

/**
 * IDL Field structure
 */
export interface IdlField {
  name: string;
  type: string | IdlTypeDef;
}

/**
 * Exploit simulation options
 */
export interface ExploitSimulationOptions {
  testValidatorUrl?: string;
  enableTesting?: boolean;
  skipDeployment?: boolean;
  useCachedIdl?: boolean;
  userWalletAddress?: string; // Optional: User's wallet address (for API compatibility)
}

/**
 * Build verification result
 */
export interface BuildVerificationResult {
  success: boolean;
  soPath?: string;
  size?: number;
  error?: string;
}
