/**
 * Comprehensive Vulnerability-to-Strategy Mapping
 * 
 * Maps every detected vulnerability type to appropriate exploit strategies.
 * This ensures every vulnerability has a corresponding exploit test.
 */

import { Vulnerability } from "../types/vulnerability.js";
import { VULNERABILITY_REGISTRY } from "../knowledge-base/vulnerability-registry.js";

/**
 * Vulnerability-to-Strategy mapping configuration
 * Each vulnerability can map to one or more exploit strategies
 */
export interface VulnerabilityStrategyMapping {
  // Vulnerability identifiers (from registry IDs or title patterns)
  vulnerabilityIds?: string[];
  titlePatterns?: string[];
  categoryPatterns?: string[];
  
  // Strategy names (must match ExploitStrategies)
  primaryStrategy: string;
  alternativeStrategies?: string[];
  
  // Exploit test configuration
  requiresIdl?: boolean;
  requiresDeployment?: boolean;
  testPayloads?: string[]; // References to fuzz payload types
}

/**
 * Complete mapping of all vulnerabilities to exploit strategies
 */
export const VULNERABILITY_STRATEGY_MAP: VulnerabilityStrategyMapping[] = [
  // ===== SOLANA PROGRAM VULNERABILITIES =====
  
  {
    vulnerabilityIds: ["missing-ownership-check"],
    titlePatterns: ["missing ownership", "ownership check", "owner verification"],
    categoryPatterns: ["account lifecycle"],
    primaryStrategy: "unchecked_owner",
    alternativeStrategies: ["owner_spoofing"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["arbitrary_account", "wrong_owner"]
  },
  
  {
    vulnerabilityIds: ["missing-signer-check"],
    titlePatterns: ["missing signer", "signer check", "is_signer"],
    categoryPatterns: ["account lifecycle"],
    primaryStrategy: "missing_signer",
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["unsigned_account"]
  },
  
  {
    vulnerabilityIds: ["type-confusion"],
    titlePatterns: ["type confusion", "arbitrary", "program invocation", "signed program", "cpi"],
    categoryPatterns: ["access control"],
    primaryStrategy: "type_confusion",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["malicious_program", "arbitrary_cpi"]
  },
  
  {
    vulnerabilityIds: ["integer-overflow"],
    titlePatterns: ["overflow", "underflow", "arithmetic", "integer"],
    categoryPatterns: ["arithmetic"],
    primaryStrategy: "unchecked_arithmetic",
    requiresIdl: true,
    requiresDeployment: false, // Can test with static analysis
    testPayloads: ["max_uint", "overflow_values", "underflow_values"]
  },
  
  {
    vulnerabilityIds: ["precision-loss"],
    titlePatterns: ["precision", "rounding", "division", "multiplication"],
    categoryPatterns: ["arithmetic"],
    primaryStrategy: "unchecked_arithmetic",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: false,
    testPayloads: ["precision_edge_cases", "division_by_zero"]
  },
  
  {
    vulnerabilityIds: ["reinitialization"],
    titlePatterns: ["reinitialization", "re-init", "init constraint", "state reset"],
    categoryPatterns: ["access control"],
    primaryStrategy: "init_without_rent",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["reinit_attack", "state_reset"]
  },
  
  {
    vulnerabilityIds: ["crank-abuse"],
    titlePatterns: ["crank", "permissionless", "abuse", "dos", "spam"],
    categoryPatterns: ["logic error"],
    primaryStrategy: "arbitrary_write",
    alternativeStrategies: ["reentrancy"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["spam_attack", "dos_payload"]
  },
  
  {
    vulnerabilityIds: ["account-data-mismatch"],
    titlePatterns: ["account data", "data mismatch", "discriminator", "data validation"],
    categoryPatterns: ["account lifecycle"],
    primaryStrategy: "deserialization_panic",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["corrupted_data", "wrong_discriminator"]
  },
  
  {
    vulnerabilityIds: ["pda-abuse"],
    titlePatterns: ["pda", "program derived address", "seed", "spoofing", "bump"],
    categoryPatterns: ["access control"],
    primaryStrategy: "pda_spoofing",
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["fake_seeds", "invalid_bump", "malicious_pda"]
  },
  
  // ===== DAPP/FRONTEND VULNERABILITIES =====
  
  {
    vulnerabilityIds: ["supply-chain-attack"],
    titlePatterns: ["supply chain", "dependency", "package", "npm"],
    categoryPatterns: ["access control"],
    primaryStrategy: "arbitrary_write", // Simulate malicious dependency behavior
    requiresIdl: false,
    requiresDeployment: false,
    testPayloads: ["malicious_dependency"]
  },
  
  {
    vulnerabilityIds: ["xss"],
    titlePatterns: ["xss", "cross-site scripting", "innerHTML", "eval"],
    categoryPatterns: ["access control"],
    primaryStrategy: "arbitrary_write",
    requiresIdl: false,
    requiresDeployment: false,
    testPayloads: ["xss_payload", "script_injection"]
  },
  
  {
    vulnerabilityIds: ["wallet-integration-flaws"],
    titlePatterns: ["wallet", "integration", "approval", "permission"],
    categoryPatterns: ["access control"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["missing_signer"],
    requiresIdl: false,
    requiresDeployment: false,
    testPayloads: ["excessive_permissions", "unauthorized_approval"]
  },
  
  // ===== ECOSYSTEM VULNERABILITIES =====
  
  {
    vulnerabilityIds: ["admin-key-compromise"],
    titlePatterns: ["admin", "authority", "governance", "multisig", "key"],
    categoryPatterns: ["access control", "governance"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["missing_signer", "unchecked_owner"],
    requiresIdl: true,
    requiresDeployment: false,
    testPayloads: ["forged_authority", "admin_bypass"]
  },
  
  {
    vulnerabilityIds: ["bridge-exploits"],
    titlePatterns: ["bridge", "cross-chain", "signature"],
    categoryPatterns: ["logic error"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["type_confusion", "arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["signature_forgery", "unauthorized_mint"]
  },
  
  // ===== EVM VULNERABILITIES =====
  
  {
    vulnerabilityIds: ["reentrancy"],
    titlePatterns: ["reentrancy", "reentrant", "external call"],
    categoryPatterns: ["reentrancy"],
    primaryStrategy: "reentrancy",
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["recursive_call", "cpi_loop"]
  },
  
  {
    vulnerabilityIds: ["weak-oracle"],
    titlePatterns: ["oracle", "price", "manipulation", "twap"],
    categoryPatterns: ["oracle manipulation"],
    primaryStrategy: "arbitrary_write",
    alternativeStrategies: ["unchecked_arithmetic"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["price_manipulation", "flash_loan"]
  },
  
  // ===== NEW ATTACK PATTERNS FROM REAL-WORLD EXPLOITS =====
  
  {
    vulnerabilityIds: ["bridge-exploit"],
    titlePatterns: ["bridge", "cross-chain", "bridge exploit"],
    categoryPatterns: ["bridge", "cross-chain"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["type_confusion", "arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["signature_forgery", "unauthorized_mint", "cross_chain_message"]
  },
  
  {
    vulnerabilityIds: ["governance-flash-loan"],
    titlePatterns: ["governance", "flash loan", "governance attack"],
    categoryPatterns: ["governance"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["governance_manipulation", "flash_loan"]
  },
  
  {
    vulnerabilityIds: ["private-key-compromise", "nonce-bias"],
    titlePatterns: ["private key", "key compromise", "nonce", "key management"],
    categoryPatterns: ["key management"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["missing_signer"],
    requiresIdl: false,
    requiresDeployment: false,
    testPayloads: ["key_inference", "nonce_analysis"]
  },
  
  {
    vulnerabilityIds: ["exit-scam", "rug-pull"],
    titlePatterns: ["exit scam", "rug pull", "admin drain"],
    categoryPatterns: ["fraud", "governance"],
    primaryStrategy: "authority_misuse",
    alternativeStrategies: ["missing_signer", "unchecked_owner"],
    requiresIdl: true,
    requiresDeployment: false,
    testPayloads: ["admin_drain", "fund_extraction"]
  },
  
  {
    vulnerabilityIds: ["pricing-manipulation"],
    titlePatterns: ["pricing", "price manipulation", "lending exploit"],
    categoryPatterns: ["oracle manipulation", "pricing"],
    primaryStrategy: "arbitrary_write",
    alternativeStrategies: ["unchecked_arithmetic"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["price_manipulation", "flash_loan", "oracle_manipulation"]
  },
  
  {
    vulnerabilityIds: ["supply-chain-compromise"],
    titlePatterns: ["supply chain", "dependency", "npm", "package"],
    categoryPatterns: ["supply chain"],
    primaryStrategy: "arbitrary_write",
    requiresIdl: false,
    requiresDeployment: false,
    testPayloads: ["malicious_dependency", "package_compromise"]
  },
  
  {
    vulnerabilityIds: ["read-only-reentrancy"],
    titlePatterns: ["read-only reentrancy", "view reentrancy"],
    categoryPatterns: ["reentrancy"],
    primaryStrategy: "reentrancy",
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["read_only_reentrancy", "view_function_exploit"]
  },
  
  // ===== NEW CRITICAL VULNERABILITY DETECTORS =====
  
  {
    vulnerabilityIds: ["sysvar-spoofing"],
    titlePatterns: ["sysvar", "sysvar spoofing", "clock", "rent", "stake history"],
    categoryPatterns: ["access control"],
    primaryStrategy: "sysvar_spoofing",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["fake_sysvar", "manipulated_clock", "fake_rent"]
  },
  
  {
    vulnerabilityIds: ["account-close-attack"],
    titlePatterns: ["account close", "close account", "rent reclamation", "lamports"],
    categoryPatterns: ["account lifecycle"],
    primaryStrategy: "account_close",
    alternativeStrategies: ["unchecked_owner", "authority_misuse"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["unauthorized_close", "rent_drain"]
  },
  
  {
    vulnerabilityIds: ["duplicate-mutable-accounts"],
    titlePatterns: ["duplicate", "duplicated account", "same account", "multiple mutable"],
    categoryPatterns: ["access control"],
    primaryStrategy: "duplicate_account",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["same_account_twice", "duplicate_rewards"]
  },
  
  {
    vulnerabilityIds: ["token-2022-hooks", "token-2022-confidential", "token-2022-extensions"],
    titlePatterns: ["token-2022", "token 2022", "transfer hook", "confidential transfer"],
    categoryPatterns: ["account lifecycle"],
    primaryStrategy: "token_2022_exploit",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["missing_hook", "confidential_balance", "extension_bypass"]
  },
  
  {
    vulnerabilityIds: ["address-poisoning"],
    titlePatterns: ["address poisoning", "address validation", "address truncation"],
    categoryPatterns: ["access control"],
    primaryStrategy: "address_poisoning",
    requiresIdl: false,
    requiresDeployment: false,
    testPayloads: ["similar_address", "truncated_display"]
  },
  
  // ===== ADDITIONAL CRITICAL VULNERABILITY DETECTORS =====
  
  {
    vulnerabilityIds: ["pda-seed-collision"],
    titlePatterns: ["pda seed", "pda collision", "seed collision", "user controlled seed"],
    categoryPatterns: ["access control"],
    primaryStrategy: "pda_collision",
    alternativeStrategies: ["pda_spoofing"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["collision_seeds", "short_seeds"]
  },
  
  {
    vulnerabilityIds: ["oracle-manipulation"],
    titlePatterns: ["oracle", "price manipulation", "oracle manipulation", "price feed"],
    categoryPatterns: ["oracle manipulation"],
    primaryStrategy: "oracle_manipulation",
    alternativeStrategies: ["arbitrary_write", "unchecked_arithmetic"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["flash_loan", "price_manipulation", "low_liquidity"]
  },
  
  {
    vulnerabilityIds: ["initialization-attack"],
    titlePatterns: ["initialization", "init attack", "reinitialize", "discriminator"],
    categoryPatterns: ["account lifecycle"],
    primaryStrategy: "initialization_attack",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["reinit_attack", "state_reset"]
  },
  
  {
    vulnerabilityIds: ["mev-frontrunning"],
    titlePatterns: ["mev", "front-running", "sandwich", "slippage", "swap"],
    categoryPatterns: ["oracle manipulation"],
    primaryStrategy: "mev_frontrunning",
    alternativeStrategies: ["arbitrary_write"],
    requiresIdl: true,
    requiresDeployment: true,
    testPayloads: ["sandwich_attack", "no_slippage", "front_run"]
  },
  
  {
    vulnerabilityIds: ["upgrade-authority-attack"],
    titlePatterns: ["upgrade authority", "upgrade", "admin", "governance", "multisig"],
    categoryPatterns: ["governance"],
    primaryStrategy: "upgrade_authority",
    alternativeStrategies: ["authority_misuse"],
    requiresIdl: true,
    requiresDeployment: false,
    testPayloads: ["upgrade_attack", "admin_bypass"]
  },
];

/**
 * Find strategy mapping for a vulnerability
 */
export function findStrategyForVulnerability(vulnerability: Vulnerability): VulnerabilityStrategyMapping | null {
  const title = vulnerability.title.toLowerCase();
  const category = (vulnerability.category || "").toLowerCase();
  
  // Try to match by registry ID first (if metadata contains it)
  const registryId = vulnerability.metadata?.registryId || 
                     vulnerability.id?.split("-")[0] || 
                     null;
  
  // Find matching mapping
  for (const mapping of VULNERABILITY_STRATEGY_MAP) {
    // Check ID match
    if (registryId && mapping.vulnerabilityIds?.includes(registryId)) {
      return mapping;
    }
    
    // Check title patterns
    if (mapping.titlePatterns?.some(pattern => title.includes(pattern.toLowerCase()))) {
      return mapping;
    }
    
    // Check category patterns
    if (mapping.categoryPatterns?.some(pattern => category.includes(pattern.toLowerCase()))) {
      return mapping;
    }
  }
  
  return null;
}

/**
 * Get all strategies for a vulnerability (primary + alternatives)
 */
export function getAllStrategiesForVulnerability(vulnerability: Vulnerability): string[] {
  const mapping = findStrategyForVulnerability(vulnerability);
  if (!mapping) return [];
  
  return [
    mapping.primaryStrategy,
    ...(mapping.alternativeStrategies || [])
  ].filter((s, i, arr) => arr.indexOf(s) === i); // Remove duplicates
}

/**
 * Check if vulnerability requires IDL for strategy-based exploit
 */
export function requiresIdlForStrategy(vulnerability: Vulnerability): boolean {
  const mapping = findStrategyForVulnerability(vulnerability);
  return mapping?.requiresIdl ?? true; // Default to true for safety
}

/**
 * Check if vulnerability requires program deployment
 */
export function requiresDeploymentForStrategy(vulnerability: Vulnerability): boolean {
  const mapping = findStrategyForVulnerability(vulnerability);
  return mapping?.requiresDeployment ?? false; // Default to false (can use static analysis)
}
