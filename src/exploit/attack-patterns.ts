/**
 * Attack Pattern Library
 * 
 * Comprehensive library of attack patterns for security research.
 * Each pattern documents prerequisites, steps, indicators, and mitigations.
 */

import { Severity } from "../types/vulnerability.js";

export interface AttackPattern {
  id: string;
  name: string;
  category: string;
  severity: Severity;
  description: string;
  prerequisites: string[];
  steps: string[];
  indicators: string[];
  mitigations: string[];
  realWorldExamples?: string[];
  references?: string[];
}

/**
 * Complete attack pattern library
 */
export const ATTACK_PATTERNS: AttackPattern[] = [
  {
    id: "type-confusion",
    name: "Type Confusion / Arbitrary CPI",
    category: "Access Control",
    severity: Severity.CRITICAL,
    description: "Exploit missing program validation to invoke malicious programs via CPI",
    prerequisites: [
      "Vulnerable program accepts arbitrary program accounts",
      "No validation before invoke_signed() or invoke()",
      "Program uses AccountInfo<'info> instead of Program<'info, T>"
    ],
    steps: [
      "1. Deploy malicious program with same interface as expected program",
      "2. Call vulnerable function with malicious program ID",
      "3. Malicious program executes with victim's authority",
      "4. Attacker gains unauthorized access to funds/state"
    ],
    indicators: [
      "Missing program ID validation",
      "Direct use of program account without checks",
      "AccountInfo<'info> used for program accounts",
      "No require!() checks for expected program IDs"
    ],
    mitigations: [
      "Always validate program IDs before CPI",
      "Use Program<'info, T> type constraints in Anchor",
      "Hardcode expected program IDs (e.g., spl_token::ID)",
      "Add require!() checks: require!(program.key() == EXPECTED_ID)"
    ],
    realWorldExamples: [
      "Wormhole Bridge Exploit (Feb 2022) - $320M loss via signature verification bypass, unauthorized minting of 120,000 wETH on Solana",
      "Multiple DeFi protocols exploited via arbitrary CPI",
      "Cashio Hack (Mar 2022) - $52M loss via collateral validation bypass, minted 2B CASH tokens without legitimate collateral"
    ],
    references: [
      "Helius: A Hitchhiker's Guide to Solana Program Security",
      "Neodyme Security Blog: Type Confusion Attacks",
      "Wormhole Bridge Exploit Analysis - February 2022",
      "Cashio Hack Post-Mortem - March 2022"
    ]
  },
  
  {
    id: "reentrancy",
    name: "Reentrancy Attack",
    category: "Reentrancy",
    severity: Severity.CRITICAL,
    description: "Exploit external calls before state updates to recursively drain funds",
    prerequisites: [
      "Function makes external CPI calls",
      "State updates occur after external call",
      "No reentrancy guard or mutex",
      "Function can be called recursively"
    ],
    steps: [
      "1. Deploy reentrant contract/program",
      "2. Call vulnerable function that makes external call",
      "3. In callback, recursively call vulnerable function",
      "4. State not updated between calls",
      "5. Drain funds through repeated calls"
    ],
    indicators: [
      "External call before state update",
      "Missing reentrancy guard",
      "No mutex or lock mechanism",
      "Checks-Effects-Interactions pattern violated"
    ],
    mitigations: [
      "Update state before external calls (CEI pattern)",
      "Use reentrancy guard (Anchor's #[reentrancy] attribute)",
      "Implement mutex/lock mechanism",
      "Use checks-effects-interactions pattern"
    ],
    realWorldExamples: [
      "Ethereum DAO Hack (2016) - Classic reentrancy, $60M loss",
      "Conic Finance (Jul 2023) - $3.3M loss via read-only reentrancy vulnerability in Ether Omnipool",
      "Nebula Revelation (Jan 2024) - $180K loss via reentrancy in staking contract, unauthorized token withdrawals",
      "Euler Finance (Mar 2023) - $197M loss via donateToReserves function allowing unbacked debt creation",
      "Multiple Solana DeFi protocols vulnerable to CPI reentrancy"
    ],
    references: [
      "Solana Reentrancy: A New Attack Vector",
      "Anchor Security: Reentrancy Guards",
      "Conic Finance Exploit Analysis - July 2023",
      "Euler Finance Incident Report - March 2023",
      "Nebula Revelation Reentrancy Attack - January 2024"
    ]
  },
  
  {
    id: "flash-loan",
    name: "Flash Loan Attack",
    category: "Oracle Manipulation",
    severity: Severity.HIGH,
    description: "Use flash loans to manipulate prices in single transaction",
    prerequisites: [
      "Price calculation vulnerable to manipulation",
      "Single-block price updates (no TWAP)",
      "Access to flash loan provider",
      "Sufficient liquidity for manipulation"
    ],
    steps: [
      "1. Borrow large amount via flash loan",
      "2. Manipulate price in vulnerable pool/DEX",
      "3. Execute profitable trade at manipulated price",
      "4. Repay flash loan",
      "5. Keep profit from price difference"
    ],
    indicators: [
      "Price oracle can be manipulated in single transaction",
      "No TWAP or multi-block price averaging",
      "Single DEX price source",
      "No slippage protection"
    ],
    mitigations: [
      "Use time-weighted average price (TWAP)",
      "Require multiple price sources",
      "Add slippage tolerance checks",
      "Use Chainlink or other trusted oracles",
      "Implement price manipulation detection"
    ],
    realWorldExamples: [
      "Mango Markets (Oct 2022) - $116M loss via MNGO token price manipulation through low-liquidity oracle feeds",
      "Polter Finance (Nov 2024) - $12M loss via flash loan manipulation of BOO token price in SpookySwap pools",
      "Typus Finance (Oct 2025) - $3.44M loss via oracle manipulation",
      "Crema Finance (Jul 2023) - $9M loss via flash loan attack on Solana DEX, price manipulation",
      "Sturdy Finance (Jun 2023) - $800K loss via price oracle manipulation",
      "2022: $403.2M lost across 41 oracle manipulation attacks in DeFi"
    ],
    references: [
      "Flash Loan Attack Vectors in DeFi",
      "Oracle Security Best Practices",
      "Mango Markets Exploit - October 2022",
      "Polter Finance Flash Loan Attack - November 2024",
      "Crema Finance Incident - July 2023"
    ]
  },
  
  {
    id: "sandwich-attack",
    name: "Sandwich Attack / MEV",
    category: "MEV / Front-running",
    severity: Severity.MEDIUM,
    description: "Front-run and back-run victim transactions to extract value",
    prerequisites: [
      "No slippage protection",
      "Transactions visible in mempool",
      "MEV bot infrastructure",
      "Sufficient capital for manipulation"
    ],
    steps: [
      "1. Monitor mempool for target transaction",
      "2. Front-run: Buy asset before target",
      "3. Target transaction executes at worse price",
      "4. Back-run: Sell asset after target",
      "5. Profit from price difference"
    ],
    indicators: [
      "No slippage tolerance checks",
      "No commit-reveal scheme",
      "Transactions visible in mempool",
      "No MEV protection"
    ],
    mitigations: [
      "Add slippage tolerance checks",
      "Implement commit-reveal scheme",
      "Use private transaction pools",
      "Add MEV protection mechanisms",
      "Use batch auctions"
    ],
    realWorldExamples: [
      "Solana (2022-2025) - $370M-$500M extracted via MEV sandwich attacks over 16 months, 50+ malicious validators blacklisted",
      "Ethereum (Nov 2024-Oct 2025) - Peak $10M/month extraction, 60K-90K attacks/month, single entity 'Jared' responsible for 70%",
      "Solana (Oct 2025) - 37 attackers, 1,518 victims, 997 SOL ($8K) extracted in 24 hours",
      "Cross-chain bridge sandwich attacks exploiting event emissions for front-running",
      "Widespread MEV extraction on both Solana and Ethereum DEXs"
    ],
    references: [
      "MEV on Solana: Current State and Solutions",
      "Front-running Protection Mechanisms",
      "EigenPhi MEV Research - Ethereum Sandwich Attacks",
      "Solana Foundation Validator Blacklist - June 2024",
      "Cross-Chain MEV Sandwich Attack Research"
    ]
  },
  
  {
    id: "pda-abuse",
    name: "PDA Abuse / Seed Spoofing",
    category: "Access Control",
    severity: Severity.CRITICAL,
    description: "Exploit weak PDA seed validation to generate unauthorized PDAs",
    prerequisites: [
      "PDA generation without canonical bump validation",
      "Weak seed constraints",
      "PDA used in critical operations",
      "No seed validation"
    ],
    steps: [
      "1. Identify PDA seed constraints",
      "2. Generate PDA with malicious seeds",
      "3. Bypass seed validation",
      "4. Access unauthorized accounts",
      "5. Manipulate state or drain funds"
    ],
    indicators: [
      "PDA without canonical bump check",
      "Weak seed validation",
      "PDA generation without constraints",
      "Missing require!() for bump validation"
    ],
    mitigations: [
      "Always validate canonical bump",
      "Use strict seed constraints",
      "Verify PDA derivation matches expected",
      "Add require!(bump == expected_bump) checks"
    ],
    realWorldExamples: [
      "Multiple Solana programs exploited via PDA abuse",
      "Seed spoofing attacks on DeFi protocols",
      "PDA validation bypasses leading to unauthorized token minting"
    ],
    references: [
      "PDA Security Best Practices",
      "Solana PDA Exploitation Techniques",
      "Secure-Contracts: Solana PDA Vulnerabilities"
    ]
  },
  
  {
    id: "missing-signer",
    name: "Missing Signer Check",
    category: "Access Control",
    severity: Severity.CRITICAL,
    description: "Bypass authority requirements by omitting signer validation",
    prerequisites: [
      "Privileged function without signer check",
      "AccountInfo<'info> used instead of Signer<'info>",
      "No is_signer validation"
    ],
    steps: [
      "1. Identify privileged function",
      "2. Call function without signing",
      "3. Bypass authority checks",
      "4. Execute unauthorized actions"
    ],
    indicators: [
      "AccountInfo<'info> in privileged context",
      "Missing Signer<'info> constraint",
      "No is_signer check",
      "Admin functions without signer validation"
    ],
    mitigations: [
      "Use Signer<'info> constraint in Anchor",
      "Add require!(account.is_signer) checks",
      "Validate signer in function logic",
      "Use Anchor's built-in signer validation"
    ],
    realWorldExamples: [
      "Cypher Protocol (Aug 2023) - $1M loss via margin/futures trading logic exploit, unauthorized fund access",
      "Cypher Protocol Insider (May 2024) - $300K misappropriated by core developer via 36 unauthorized withdrawals from redemption contract",
      "Multiple DeFi protocols exploited via missing signer checks",
      "Admin function bypasses in Solana programs"
    ],
    references: [
      "Anchor Security: Signer Validation",
      "Missing Signer Check Vulnerabilities",
      "Cypher Protocol Exploit - August 2023",
      "Cypher Developer Insider Theft - May 2024"
    ]
  },
  
  {
    id: "missing-ownership",
    name: "Missing Ownership Check",
    category: "Access Control",
    severity: Severity.CRITICAL,
    description: "Use accounts owned by wrong program to bypass ownership checks",
    prerequisites: [
      "Account ownership not validated",
      "AccountInfo<'info> used instead of Account<'info, T>",
      "No owner validation before use"
    ],
    steps: [
      "1. Create account owned by wrong program",
      "2. Pass account to vulnerable function",
      "3. Bypass ownership validation",
      "4. Access unauthorized accounts"
    ],
    indicators: [
      "AccountInfo<'info> without owner check",
      "Missing Account<'info, T> constraint",
      "No require!(account.owner == EXPECTED_OWNER) check"
    ],
    mitigations: [
      "Use Account<'info, T> constraint in Anchor",
      "Validate account owner before use",
      "Add require!() checks for ownership",
      "Use Anchor's built-in ownership validation"
    ],
    realWorldExamples: [
      "Cashio Hack (Mar 2022) - $52M loss via inadequate collateral account validation, fake accounts with worthless tokens",
      "Multiple Solana programs exploited via ownership bypass",
      "Token account ownership confusion attacks",
      "Account data structure validation failures leading to unauthorized access"
    ],
    references: [
      "Anchor Security: Ownership Validation",
      "Account Ownership Best Practices",
      "Cashio Hack Analysis - March 2022",
      "Halborn: Cashio Exploit Explained"
    ]
  },
  
  {
    id: "integer-overflow",
    name: "Integer Overflow/Underflow",
    category: "Arithmetic",
    severity: Severity.HIGH,
    description: "Exploit unchecked arithmetic to cause overflow/underflow",
    prerequisites: [
      "Unchecked arithmetic operations",
      "No checked_add/checked_sub/checked_mul",
      "Direct use of +, -, * operators"
    ],
    steps: [
      "1. Identify arithmetic operations",
      "2. Provide extreme values (u64::MAX, etc.)",
      "3. Trigger overflow/underflow",
      "4. Exploit unexpected results",
      "5. Manipulate calculations"
    ],
    indicators: [
      "Unchecked arithmetic operations",
      "Missing checked_add/checked_sub/checked_mul",
      "Direct use of +, -, * operators",
      "No overflow protection"
    ],
    mitigations: [
      "Use checked arithmetic: checked_add(), checked_sub(), checked_mul()",
      "Add overflow checks with ok_or()",
      "Use safe math libraries",
      "Validate input ranges"
    ],
    realWorldExamples: [
      "Multiple arithmetic vulnerabilities in Solana programs",
      "Overflow attacks on token calculations",
      "Precision loss in DeFi calculations leading to fund drainage"
    ],
    references: [
      "Rust Safe Arithmetic",
      "Integer Overflow Prevention",
      "DeFi Arithmetic Vulnerability Research"
    ]
  },

  {
    id: "bridge-exploit",
    name: "Bridge Exploit / Cross-Chain Attack",
    category: "Bridge / Cross-Chain",
    severity: Severity.CRITICAL,
    description: "Exploit vulnerabilities in cross-chain bridges to mint unauthorized tokens or drain funds",
    prerequisites: [
      "Bridge with signature verification flaws",
      "Compromised validator keys or multisig",
      "Insufficient validation of cross-chain messages",
      "Single point of failure in bridge architecture"
    ],
    steps: [
      "1. Identify bridge vulnerability (signature verification, key compromise, or logic error)",
      "2. Forge cross-chain messages or compromise validator keys",
      "3. Mint tokens on destination chain without proper collateral",
      "4. Withdraw or transfer unauthorized funds",
      "5. Bridge becomes insolvent or funds drained"
    ],
    indicators: [
      "Weak signature verification in bridge contracts",
      "Single admin key or weak multisig",
      "No rate limiting on bridge operations",
      "Insufficient validation of cross-chain messages",
      "Centralized validator set"
    ],
    mitigations: [
      "Implement robust multi-signature schemes with time-locks",
      "Use decentralized validator sets",
      "Add rate limits and monitoring",
      "Conduct thorough security audits",
      "Implement circuit breakers for large transfers",
      "Use multiple independent oracles for verification"
    ],
    realWorldExamples: [
      "Ronin Network (Mar 2022) - $624M loss via private key compromise, fraudulent withdrawals",
      "Wormhole Bridge (Feb 2022) - $320M loss via signature verification bypass",
      "Nomad Bridge (Aug 2022) - $190M loss via smart contract flaw enabling fund drainage",
      "BSC Token Hub (Oct 2022) - $560M loss via unauthorized minting of 2M BNB tokens",
      "Harmony Horizon Bridge (Aug 2024) - $100M loss via compromised multisig wallet",
      "Multichain (Jul 2024) - $126M loss via compromised validator keys",
      "Orbit Chain (Jan 2024) - $81M loss via cross-chain bridge exploit",
      "Force Bridge (Jun 2025) - $3.6M loss via private key compromise",
      "By Oct 2022: $2B+ stolen from bridges (69% of all crypto theft)",
      "By Nov 2025: $3.2B+ lost from bridge exploits since May 2021"
    ],
    references: [
      "Beosin Global Web3 Security Report 2022",
      "Cross-Chain Bridge Security Best Practices",
      "Ronin Network Exploit Analysis",
      "Wormhole Bridge Incident Report"
    ]
  },

  {
    id: "governance-flash-loan",
    name: "Governance Flash Loan Attack",
    category: "Governance / Flash Loan",
    severity: Severity.CRITICAL,
    description: "Use flash loans to acquire governance tokens and pass malicious proposals",
    prerequisites: [
      "Governance tokens can be acquired via flash loans",
      "No time-lock on governance proposals",
      "Proposals can transfer funds or modify critical parameters",
      "Flash loan provider available"
    ],
    steps: [
      "1. Borrow large amount via flash loan",
      "2. Purchase majority of governance tokens",
      "3. Submit malicious proposal (fund transfer or parameter change)",
      "4. Vote with acquired tokens to pass proposal",
      "5. Execute proposal to drain funds",
      "6. Repay flash loan and keep profit"
    ],
    indicators: [
      "Governance tokens tradeable on DEXs",
      "No time-lock on proposal execution",
      "Proposals can transfer protocol funds",
      "Flash loans available for governance tokens",
      "No minimum voting period"
    ],
    mitigations: [
      "Implement time-locks on governance proposals",
      "Require minimum voting periods",
      "Limit proposal execution scope",
      "Use multi-sig for critical operations",
      "Implement flash loan detection",
      "Require staking period before voting"
    ],
    realWorldExamples: [
      "Beanstalk Farms (Apr 2022) - $182M loss via flash loan governance attack, attacker acquired majority Stalk tokens, passed malicious proposal transferring all funds, $80M profit after loan repayment"
    ],
    references: [
      "Beanstalk Governance Exploit Analysis - April 2022",
      "Flash Loan Governance Attack Prevention",
      "DeFi Governance Security Best Practices"
    ]
  },

  {
    id: "private-key-compromise",
    name: "Private Key Compromise / Nonce Bias",
    category: "Key Management",
    severity: Severity.CRITICAL,
    description: "Exploit predictable nonce generation or key management flaws to infer private keys",
    prerequisites: [
      "Predictable nonce generation in signatures",
      "Weak key generation or storage",
      "Insider access to private keys",
      "Supply chain compromise of key management"
    ],
    steps: [
      "1. Identify predictable pattern in nonce generation",
      "2. Analyze millions of blockchain signatures",
      "3. Infer private keys from nonce bias",
      "4. Access compromised wallets",
      "5. Drain funds from affected accounts"
    ],
    indicators: [
      "Predictable nonce patterns in transactions",
      "Single point of key storage",
      "No hardware security module (HSM)",
      "Keys stored in plaintext or weak encryption",
      "Insider access to key management systems"
    ],
    mitigations: [
      "Use cryptographically secure random nonce generation",
      "Implement hardware security modules (HSM)",
      "Use multi-signature wallets",
      "Implement key rotation policies",
      "Separate hot and cold wallet infrastructure",
      "Regular security audits of key management"
    ],
    realWorldExamples: [
      "Upbit Exchange (Nov 2025) - $30M loss from Solana hot wallet via nonce bias vulnerability, attackers inferred private keys by analyzing signature patterns",
      "Slope Wallet (Aug 2022) - $8M loss from 8,000 wallets via supply chain attack compromising wallet security",
      "Ronin Network (Mar 2022) - Private key compromise leading to $624M bridge exploit",
      "Multiple exchange hot wallet compromises via key management flaws"
    ],
    references: [
      "Upbit Hack Analysis - Nonce Bias Vulnerability",
      "Slope Wallet Breach Investigation",
      "Cryptographic Key Management Best Practices",
      "Solana Transaction Security Guidelines"
    ]
  },

  {
    id: "exit-scam",
    name: "Exit Scam / Rug Pull",
    category: "Fraud / Governance",
    severity: Severity.CRITICAL,
    description: "Project team drains user funds and disappears, often via admin key abuse",
    prerequisites: [
      "Centralized admin keys or weak governance",
      "No time-locks on admin functions",
      "Large user deposits in protocol",
      "Lack of transparency in team identity"
    ],
    steps: [
      "1. Launch protocol and attract user deposits",
      "2. Accumulate significant TVL",
      "3. Use admin keys to drain funds",
      "4. Disappear or claim hack",
      "5. Users lose all deposited funds"
    ],
    indicators: [
      "Anonymous or unverified team",
      "Single admin key control",
      "No time-locks on critical functions",
      "Unusual token distribution",
      "Lack of security audits",
      "Rapid TVL growth without audits"
    ],
    mitigations: [
      "Require KYC for project teams",
      "Implement multi-sig with time-locks",
      "Conduct thorough security audits",
      "Use decentralized governance",
      "Implement circuit breakers",
      "Require transparency in team identity"
    ],
    realWorldExamples: [
      "LIBRA Exit Scam (Feb 2025) - Large-scale exit scam on Solana",
      "MELANIA Exit Scam (Feb 2025) - Large-scale exit scam on Solana",
      "Combined LIBRA and MELANIA losses: $486M",
      "Multiple Solana token projects with exit scams"
    ],
    references: [
      "DeFi REKT Report Q1 2025",
      "Exit Scam Prevention Guidelines",
      "Solana Project Due Diligence Checklist"
    ]
  },

  {
    id: "pricing-manipulation",
    name: "Pricing Mechanism Manipulation",
    category: "Oracle Manipulation",
    severity: Severity.HIGH,
    description: "Exploit vulnerable pricing mechanisms in lending/borrowing protocols",
    prerequisites: [
      "Vulnerable pricing calculation",
      "Low liquidity in price source",
      "No TWAP or price averaging",
      "Single source price feed"
    ],
    steps: [
      "1. Identify vulnerable pricing mechanism",
      "2. Manipulate price through low-liquidity trades or flash loans",
      "3. Exploit manipulated price to borrow excess funds",
      "4. Withdraw borrowed funds",
      "5. Price returns to normal, leaving protocol insolvent"
    ],
    indicators: [
      "Single DEX as price source",
      "No TWAP implementation",
      "Low liquidity in price pools",
      "Pricing based on spot price only",
      "No price manipulation detection"
    ],
    mitigations: [
      "Implement TWAP (Time-Weighted Average Price)",
      "Use multiple independent price sources",
      "Add liquidity requirements for price feeds",
      "Implement price manipulation detection",
      "Use Chainlink or other trusted oracles",
      "Add circuit breakers for price deviations"
    ],
    realWorldExamples: [
      "Loopscale (Apr 2025) - $5.8M loss via pricing mechanism manipulation, attacker manipulated loan conditions to extract funds from vaults",
      "Mango Markets (Oct 2022) - $116M loss via MNGO token price manipulation",
      "Multiple lending protocols exploited via pricing vulnerabilities"
    ],
    references: [
      "DeFi REKT Report April 2025",
      "Loopscale Exploit Analysis",
      "Pricing Mechanism Security in DeFi"
    ]
  },

  {
    id: "supply-chain-compromise",
    name: "Supply Chain Attack",
    category: "Supply Chain",
    severity: Severity.CRITICAL,
    description: "Compromise third-party dependencies to inject malicious code into dApps",
    prerequisites: [
      "Outdated or unverified npm packages",
      "No dependency scanning",
      "Compromised package maintainer",
      "Weak package verification"
    ],
    steps: [
      "1. Compromise popular npm package or dependency",
      "2. Inject malicious code into package",
      "3. Package used by target dApp",
      "4. Malicious code executes in user's browser",
      "5. Steal private keys or drain wallets"
    ],
    indicators: [
      "Outdated package versions",
      "Suspicious package maintainers",
      "No dependency scanning",
      "Package-lock.json mismatches",
      "Unverified dependencies"
    ],
    mitigations: [
      "Regular dependency updates and scanning",
      "Use verified, audited packages",
      "Implement package integrity checks",
      "Monitor for suspicious package changes",
      "Use dependency pinning",
      "Conduct supply chain security audits"
    ],
    realWorldExamples: [
      "Slope Wallet (Aug 2022) - $8M loss from 8,000 wallets via supply chain attack on wallet infrastructure",
      "Multiple npm package compromises targeting crypto wallets",
      "Supply chain attacks on DeFi frontends"
    ],
    references: [
      "Supply Chain Attacks in Solana Ecosystem - Adevar Labs",
      "npm Package Security Best Practices",
      "Slope Wallet Breach Investigation"
    ]
  },

  {
    id: "read-only-reentrancy",
    name: "Read-Only Reentrancy",
    category: "Reentrancy",
    severity: Severity.CRITICAL,
    description: "Exploit read-only external calls to manipulate state before updates",
    prerequisites: [
      "Read-only external calls before state updates",
      "State read during external call",
      "No reentrancy guard on read operations",
      "View functions that can be exploited"
    ],
    steps: [
      "1. Identify function with read-only external call",
      "2. Deploy malicious contract that calls back during read",
      "3. Manipulate state during read operation",
      "4. Exploit inconsistent state",
      "5. Drain funds using manipulated state"
    ],
    indicators: [
      "View functions making external calls",
      "State reads during external calls",
      "No reentrancy guard on view functions",
      "State updates after external reads"
    ],
    mitigations: [
      "Apply reentrancy guards to all external calls",
      "Update state before external calls",
      "Avoid state reads during external calls",
      "Use checks-effects-interactions pattern",
      "Implement mutex for critical sections"
    ],
    realWorldExamples: [
      "Conic Finance (Jul 2023) - $3.3M loss via read-only reentrancy in Ether Omnipool, combined with flash loans and front-running"
    ],
    references: [
      "Conic Finance Exploit Analysis - July 2023",
      "Read-Only Reentrancy: A New Attack Vector",
      "DeFi Reentrancy Security Best Practices"
    ]
  }
];

/**
 * Get attack pattern by ID
 */
export function getAttackPattern(id: string): AttackPattern | undefined {
  return ATTACK_PATTERNS.find(p => p.id === id);
}

/**
 * Get attack patterns by category
 */
export function getAttackPatternsByCategory(category: string): AttackPattern[] {
  return ATTACK_PATTERNS.filter(p => p.category.toLowerCase() === category.toLowerCase());
}

/**
 * Get all prerequisites for a vulnerability type
 */
export function getPrerequisitesForVulnerability(vulnerabilityTitle: string): string[] {
  const pattern = ATTACK_PATTERNS.find(p => 
    vulnerabilityTitle.toLowerCase().includes(p.name.toLowerCase()) ||
    vulnerabilityTitle.toLowerCase().includes(p.id.replace("-", " "))
  );
  return pattern?.prerequisites || [];
}
