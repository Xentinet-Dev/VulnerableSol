/**
 * Automatic Account Initializer
 * 
 * Creates PDAs, token accounts, mints, ATAs, and generic state accounts
 * for realistic exploit testing environments
 */

import {
  Connection,
  PublicKey,
  Keypair,
  SystemProgram,
  Transaction,
  sendAndConfirmTransaction,
} from "@solana/web3.js";
import {
  createMint,
  getOrCreateAssociatedTokenAccount,
} from "@solana/spl-token";

export interface InitializedAccounts {
  mint?: PublicKey;
  ata?: PublicKey;
  pda?: PublicKey;
  state?: PublicKey;
  payer: PublicKey;
  [key: string]: PublicKey | undefined;
}

export class AccountInitializer {
  constructor(
    private connection: Connection,
    private payer: Keypair
  ) {}

  /**
   * Create PDA using arbitrary seeds
   */
  async createPda(seed: string, programId: PublicKey): Promise<PublicKey> {
    const [pda] = PublicKey.findProgramAddressSync(
      [Buffer.from(seed)],
      programId
    );
    return pda;
  }

  /**
   * Create a mint
   */
  async createMintAccount(): Promise<PublicKey> {
    try {
      return await createMint(
        this.connection,
        this.payer,
        this.payer.publicKey,
        null,
        9
      );
    } catch (error: any) {
      throw new Error(`Failed to create mint: ${error.message}`);
    }
  }

  /**
   * Create user token account (ATA)
   */
  async createTokenAccount(mint: PublicKey): Promise<PublicKey> {
    try {
      const ata = await getOrCreateAssociatedTokenAccount(
        this.connection,
        this.payer,
        mint,
        this.payer.publicKey
      );
      return ata.address;
    } catch (error: any) {
      throw new Error(`Failed to create token account: ${error.message}`);
    }
  }

  /**
   * Create a generic state account with N bytes
   */
  async createStateAccount(size: number = 256, programId?: PublicKey): Promise<PublicKey> {
    const state = Keypair.generate();
    const program = programId || SystemProgram.programId;

    try {
      const rentExemptAmount = await this.connection.getMinimumBalanceForRentExemption(size);

      const tx = new Transaction().add(
        SystemProgram.createAccount({
          fromPubkey: this.payer.publicKey,
          newAccountPubkey: state.publicKey,
          space: size,
          lamports: rentExemptAmount,
          programId: program,
        })
      );

      await sendAndConfirmTransaction(
        this.connection,
        tx,
        [this.payer, state],
        { commitment: "confirmed" }
      );

      return state.publicKey;
    } catch (error: any) {
      throw new Error(`Failed to create state account: ${error.message}`);
    }
  }

  /**
   * Initialize a minimal ecosystem for exploit attempts
   */
  async prepareProgramTestEnv(programId: PublicKey): Promise<InitializedAccounts> {
    const accounts: InitializedAccounts = {
      payer: this.payer.publicKey,
    };

    try {
      // Create mint
      console.log("[*] Creating mint account...");
      accounts.mint = await this.createMintAccount();
      console.log(`[+] Mint created: ${accounts.mint.toBase58().slice(0, 16)}...`);

      // Create ATA
      console.log("[*] Creating associated token account...");
      accounts.ata = await this.createTokenAccount(accounts.mint);
      console.log(`[+] ATA created: ${accounts.ata.toBase58().slice(0, 16)}...`);

      // Create PDA
      console.log("[*] Creating PDA...");
      accounts.pda = await this.createPda("test", programId);
      console.log(`[+] PDA created: ${accounts.pda.toBase58().slice(0, 16)}...`);

      // Create state account
      console.log("[*] Creating state account...");
      accounts.state = await this.createStateAccount(128, programId);
      console.log(`[+] State account created: ${accounts.state.toBase58().slice(0, 16)}...`);

      return accounts;
    } catch (error: any) {
      console.error(`[!] Failed to prepare test environment: ${error.message}`);
      // Return partial accounts if some succeeded
      return accounts;
    }
  }

  /**
   * Create multiple PDAs with different seeds (for testing seed constraints)
   */
  async createMultiplePdas(programId: PublicKey, count: number = 5): Promise<PublicKey[]> {
    const pdas: PublicKey[] = [];
    for (let i = 0; i < count; i++) {
      const seed = `test-seed-${i}`;
      const pda = await this.createPda(seed, programId);
      pdas.push(pda);
    }
    return pdas;
  }

  /**
   * Create a writable account owned by a specific program (for ownership testing)
   */
  async createProgramOwnedAccount(
    ownerProgramId: PublicKey,
    size: number = 256
  ): Promise<PublicKey> {
    return await this.createStateAccount(size, ownerProgramId);
  }
}

